<div class="container-fluid mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Órdenes de Compra para la Orden de Venta {{ salesorder.sapcode }}</h2>
    </div>

    <div class="list-group" id="ordenes-compra-container">
        {% for order in purchase_orders %}
        <div class="list-group-item d-flex flex-column mb-3" id="orden-{{ order.id }}" style="border: 1px solid #d1d5db; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); padding: 20px; background: linear-gradient(135deg, #ffffff, #f2f5f8);">
            
            <!-- Primera fila: Encargado, Clase, Tipo -->
            <div class="row mb-2">
                <div class="col-lg-2 col-md-4 col-sm-6 mb-2 d-flex flex-column justify-content-between">
                    <div class="d-flex align-items-center mb-2">
                        <label class="me-2 mb-0"><strong>Encargado:</strong></label>
                        <span class="badge bg-primary">{{ order.requested_by }}</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <label class="me-2 mb-0"><strong>Clase:</strong></label>
                        <select name="class_pay" form="form-{{ order.id }}" class="form-select form-select-sm">
                            <option value="Bancos" {% if order.class_pay == "Bancos" %} selected {% endif %}>Bancos</option>
                            <option value="Planillas" {% if order.class_pay == "Planillas" %} selected {% endif %}>Planillas</option>
                            <option value="Servicios" {% if order.class_pay == "Servicios" %} selected {% endif %}>Servicios</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center">
                        <label class="me-2 mb-0"><strong>Tipo:</strong></label>
                        <select name="type_pay" form="form-{{ order.id }}" class="form-select form-select-sm">
                            <option value="Prestamo" {% if order.type_pay == "Prestamo" %} selected {% endif %}>Préstamo</option>
                            <option value="Tarjeta" {% if order.type_pay == "Tarjeta" %} selected {% endif %}>Tarjeta</option>
                        </select>
                    </div>
                </div>

                <!-- Segunda fila: Proveedor, Descripción, Detalle -->
                <div class="col-lg-8 col-md-8 col-sm-12 mb-2">
                    <div class="d-flex align-items-center mb-2">
                        <label class="me-2 mb-0"><strong>Proveedor:</strong></label>
                        <select name="proveedor" form="form-{{ order.id }}" class="form-select form-select-sm select2">
                            {% if order.proveedor %}
                            <option value="{{ order.proveedor.id }}" selected>{{ order.proveedor.nombre_proveedor }}</option>
                            {% else %}
                            <option value="" selected>Seleccionar</option>
                            {% endif %}
                            {% for proveedor in proveedores %}
                            <option value="{{ proveedor.id }}">{{ proveedor.nombre_proveedor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <label class="me-2 mb-0"><strong>Descripción:</strong></label>
                        <div>{{ order.description }}</div>
                    </div>
                </div>

                <!-- Tercera fila: Cantidad, Precio, Total -->
                <div class="col-lg-2 col-md-4 col-sm-6 mb-2 d-flex flex-column justify-content-between">
                    <div class="d-flex align-items-center mb-2">
                        <label class="me-2 mb-0"><strong>CANT:</strong></label>
                        <input class="form-control form-control-sm" form="form-{{ order.id }}" type="number" name="cantidad" value="{{ order.quantity_requested }}" />
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <label class="me-2 mb-0"><strong>Precio:</strong></label>
                        <input class="form-control form-control-sm" form="form-{{ order.id }}" type="number" name="price" value="{{ order.price }}" step="0.01" />
                    </div>
                    <div class="d-flex align-items-center">
                        <label class="me-2 mb-0"><strong>Total:</strong></label>
                        <div id="precio-total-{{ order.id }}">{{ order.price_total|floatformat:2 }}</div>
                    </div>
                </div>
            </div>

            <!-- Ítems para la Orden de Compra -->
            <h6 class="mt-3">Ítems para la Orden de Compra {{ order.id }}</h6>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Código SAP</th>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Precio Total</th>
                            <th>Clase Pago</th>
                            <th>Tipo Pago</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items.all %}
                        <tr>
                            <td>{{ item.sap_code }}</td>
                            <td>{{ item.sales_order_item.description }}</td>
                            <td>{{ item.quantity_requested }}</td>
                            <td>{{ item.price }}</td>
                            <td>{{ item.price_total }}</td>
                            <td>{{ item.class_pay }}</td>
                            <td>{{ item.type_pay }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">No se encontraron ítems para esta orden de compra.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Fila de acciones: Guardar y Eliminar -->
            <div class="row mt-2">
                <div class="col d-flex justify-content-end align-items-center">
                    <form id="form-{{ order.id }}" hx-post="" hx-target="#precio-total-{{ order.id }}" hx-swap="outerHTML" method="post" class="d-flex">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary btn-sm me-1"><i class="fas fa-check"></i> Guardar</button>
                    </form>
                    <button class="btn btn-danger btn-sm" hx-delete="" hx-target="#orden-{{ order.id }}" hx-swap="outerHTML">
                        <i class="fas fa-times"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
