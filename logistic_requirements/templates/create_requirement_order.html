{% extends 'base_logistic.html' %}

{% load widget_tweaks %}

{% block content %}
<div class="container">
    <h1>Crear Nueva Orden de Requerimiento</h1>

    <form method="post">
        {% csrf_token %}

        <!-- Formulario para RequirementOrder -->
        <div class="mb-3">
            <h3>Detalles de la Orden</h3>
            <div class="form-group">
                <label for="id_sales_order">Orden de Venta</label>
                {{ order_form.sales_order|add_class:"form-control" }}
            </div>
            <div class="form-group">
                <label for="id_requested_date">Fecha Solicitada</label>
                {{ order_form.requested_date|add_class:"form-control" |attr:"type:date" }}
            </div>
            <div class="form-group">
                <label for="id_notes">Notas</label>
                {{ order_form.notes|add_class:"form-control" |attr:"placeholder:Añadir notas (opcional)" }}
            </div>
        </div>

        <!-- Formset para los ítems de la orden -->
        <h3>Ítems de la Orden</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Cantidad</th>
                    <th>Notas</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {{ formset.management_form }}
                {% for form in formset %}
                <tr>
                    <td>{{ form.sales_order_item|add_class:"form-control" }}</td>
                    <td>{{ form.quantity_requested|add_class:"form-control" |attr:"min:1" }}</td>
                    <td>{{ form.notes|add_class:"form-control" |attr:"placeholder:Añadir notas del ítem (opcional)" }}</td>
                    <td>
                        <button type="button" class="btn btn-danger" onclick="removeForm(this)">Eliminar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Botón para agregar más ítems -->
        <button type="button" class="btn btn-secondary" id="add-item-btn">Agregar Ítem</button>

        <!-- Botones de acción -->
        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Guardar Orden de Requerimiento</button>
            <a href="{% url 'requirement_order_list' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
// Script para agregar un nuevo formulario de ítem dinámicamente
// Script para agregar un nuevo formulario de ítem dinámicamente
document.getElementById('add-item-btn').addEventListener('click', function() {
    // Contar los formularios actuales en el tbody
    var formIdx = document.querySelectorAll('tbody tr').length;

    // Clonar el formulario vacío y reemplazar el prefijo con el nuevo índice
    var emptyFormHtml = document.getElementById('empty-form').innerHTML.replace(/__prefix__/g, formIdx);
    var newRow = document.createElement('tr');
    newRow.innerHTML = emptyFormHtml;
    document.querySelector('tbody').appendChild(newRow);

    // Incrementar el valor de total_forms en el management_form
    var totalForms = document.getElementById('id_items-TOTAL_FORMS');
    totalForms.value = formIdx + 1;  // Aumenta el total de formularios
});


// Script para eliminar un formulario de ítem
function removeForm(btn) {
    btn.closest('tr').remove();
}
</script>

<!-- Formulario vacío para clonar -->
<template id="empty-form">
    <tr>
        <td>{{ formset.empty_form.sales_order_item|add_class:"form-control" }}</td>
        <td>{{ formset.empty_form.quantity_requested|add_class:"form-control" |attr:"min:1" }}</td>
        <td>{{ formset.empty_form.notes|add_class:"form-control" |attr:"maxlength:255" |attr:"placeholder:Añadir notas del ítem (opcional)" }}</td>
        <td>
            <button type="button" class="btn btn-danger" onclick="removeForm(this)">Eliminar</button>
        </td>
    </tr>
</template>

{% endblock %}
